---
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";
import Button from "../Button/Button.astro";

/*
Props:
- id?: string
- action?: string
- method?: "get" | "post"
- target?: string
- enctype?: string
- novalidate?: boolean       // defaults true to avoid native browser bubbles
- preventEnterSubmit?: boolean   // defaults true
- submitLabel?: string            // default "Send"
- submitVariant?: "solid" | "outline" | "ghost"
- submitSize?: "sm" | "md" | "lg"
- submitDisabled?: boolean
- showReset?: boolean
- resetLabel?: string             // default "Reset"
- resetVariant?: "solid" | "outline" | "ghost"
- resetSize?: "sm" | "md" | "lg"
- resetDisabled?: boolean
- errors?: Record<string, string | string[]>
- globalErrors?: Array<string>
- showErrorSummary?: boolean
- errorSummaryTitle?: string
- validateOnSubmit?: boolean
- class?: string
- style?: string
*/

const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  action: { type: "string" },
  method: { type: "string" },
  target: { type: "string" },
  enctype: { type: "string" },
  novalidate: { type: "boolean" },
  preventEnterSubmit: { type: "boolean" },
  submitLabel: { type: "string" },
  submitVariant: { type: "string" },
  submitSize: { type: "string" },
  submitDisabled: { type: "boolean" },
  showReset: { type: "boolean" },
  resetLabel: { type: "string" },
  resetVariant: { type: "string" },
  resetSize: { type: "string" },
  resetDisabled: { type: "boolean" },
  errors: { type: "object" },
  globalErrors: { type: "array" },
  showErrorSummary: { type: "boolean" },
  errorSummaryTitle: { type: "string" },
  validateOnSubmit: { type: "boolean" }
};

const {
  id,
  class: className,
  style,
  action,
  method = "post",
  target,
  enctype,
  novalidate = true,
  preventEnterSubmit = true,
  submitLabel = "Send",
  submitVariant = "solid",
  submitSize = "md",
  submitDisabled = false,
  showReset = true,
  resetLabel = "Reset",
  resetVariant = "outline",
  resetSize = "md",
  resetDisabled = false,
  errors = {},
  globalErrors = [],
  showErrorSummary = true,
  errorSummaryTitle = "Please fix the following errors:",
  validateOnSubmit = true,
  ...rest
} = validateProps(schema, Astro.props, { component: "Form" });

const formId = id ?? `form-${Math.random().toString(36).slice(2, 9)}`;
const resolvedMethod = method?.toLowerCase?.() ?? "post";

const entries = Object.entries(errors || {}).filter(
  ([, value]) => value !== undefined && value !== null
);
const normalizeArray = (value) =>
  Array.isArray(value) ? value : value !== undefined && value !== null ? [value] : [];
const fieldErrors = entries.flatMap(([field, value]) =>
  normalizeArray(value).map((msg) => ({ field, msg: String(msg) }))
);
const globalErrorList = normalizeArray(globalErrors).map((msg) => String(msg));
const hasErrors = globalErrorList.length + fieldErrors.length > 0;
const summaryId = `${formId}-error-summary`;
const summaryListId = `${summaryId}-list`;

const styleVars = {};
const resolvedStyle = makeStyleVars(styleVars, style);
const resolvedClass = mergeClasses("form", className);
---

<form
  id={formId}
  class={resolvedClass}
  action={action}
  method={resolvedMethod}
  target={target}
  enctype={enctype}
  novalidate={novalidate ? true : undefined}
  data-validate={validateOnSubmit ? "true" : "false"}
  data-prevent-enter={preventEnterSubmit ? "true" : undefined}
  style={resolvedStyle || undefined}
  {...rest}
>
  {
    showErrorSummary ? (
      <div
        class={`form-error-summary ${hasErrors ? "" : "is-hidden"}`.trim()}
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        tabindex="-1"
        id={summaryId}
        data-error-summary
        hidden={!hasErrors}
      >
        <p class="summary-title" data-summary-title>
          {errorSummaryTitle}
        </p>
        <ul id={summaryListId} data-error-list>
          {globalErrorList.map((err) => (
            <li>{err}</li>
          ))}
          {fieldErrors.map(({ field, msg }) => (
            <li>
              {field ? <strong>{field}:</strong> : null} {msg}
            </li>
          ))}
        </ul>
      </div>
    ) : null
  }

  <div class="form-body">
    <slot />
  </div>

  <div class="form-actions">
    {
      showReset ? (
        <slot name="reset">
          <Button type="reset" variant={resetVariant} size={resetSize} disabled={resetDisabled}>
            {resetLabel}
          </Button>
        </slot>
      ) : null
    }

    <slot name="submit">
      <Button type="submit" variant={submitVariant} size={submitSize} disabled={submitDisabled}>
        {submitLabel}
      </Button>
    </slot>
  </div>
</form>

<script is:inline>
  document.querySelectorAll("form[data-prevent-enter]").forEach((form) => {
    if (!(form instanceof HTMLFormElement)) return;
    if (form.dataset.enterBound === "true") return;
    form.dataset.enterBound = "true";
    form.addEventListener("keydown", (event) => {
      if (event.key !== "Enter") return;
      const target = event.target;
      if (!target) return;
      const tag = target.tagName?.toLowerCase();
      const type = target.getAttribute?.("type");
      const allow =
        tag === "textarea" ||
        tag === "select" ||
        type === "submit" ||
        type === "button" ||
        type === "reset";
      if (allow) return;
      event.preventDefault();
    });
  });
</script>

<script is:inline>
  document.querySelectorAll("form").forEach((form) => {
    if (!(form instanceof HTMLFormElement)) return;
    if (form.dataset.validationBound === "true") return;
    form.dataset.validationBound = "true";
    const summary = form.querySelector("[data-error-summary]");
    const list = summary?.querySelector("[data-error-list]");
    const summaryTitle = summary?.querySelector("[data-summary-title]");
    const shouldValidate = form.dataset.validate !== "false";
    const action = form.getAttribute("action");
    const method = (form.getAttribute("method") || "post").toUpperCase();
    const enctype = form.getAttribute("enctype") || "application/x-www-form-urlencoded";

    // Focus summary if server-rendered errors exist
    if (summary && summary.hidden === false) {
      summary.focus({ preventScroll: false });
    }

    form.addEventListener("submit", async (event) => {
      if (!shouldValidate) return;

      const invalidFields = Array.from(form.querySelectorAll("input, select, textarea")).filter(
        (el) => !el.checkValidity()
      );

      if (invalidFields.length) {
        event.preventDefault();
        if (summary && list) {
          summaryTitle && (summaryTitle.textContent = "Please fix the following errors:");
          list.innerHTML = "";
          invalidFields.forEach((el) => {
            const id = el.id;
            const label =
              (id ? form.querySelector(`label[for="${id}"]`)?.textContent?.trim() : "") ||
              el.getAttribute("aria-label") ||
              el.getAttribute("name") ||
              id ||
              "This field";
            const li = document.createElement("li");
            li.textContent = `${label} is required or invalid.`;
            list.appendChild(li);
          });
          summary.hidden = false;
          summary.classList.remove("is-hidden");
          summary.classList.remove("is-success");
          summary.focus({ preventScroll: false });
          summary.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        return;
      }

      if (action) {
        event.preventDefault();
        if (!summary || !list) return;
        list.innerHTML = "";
        summary.classList.remove("is-success");
        summary.hidden = true;
        summary.classList.add("is-hidden");

        const formData = new FormData(form);
        const opts = { method, headers: {} };

        if (method === "GET") {
          const params = new URLSearchParams(formData);
          const sep = action.includes("?") ? "&" : "?";
          try {
            const res = await fetch(action + sep + params.toString(), opts);
            await handleResponse(res);
          } catch (err) {
            showError(err);
          }
          return;
        }

        if (enctype === "application/json") {
          opts.headers["Content-Type"] = "application/json";
          opts.body = JSON.stringify(Object.fromEntries(formData));
        } else {
          opts.body = formData;
        }

        try {
          const res = await fetch(action, opts);
          await handleResponse(res);
        } catch (err) {
          showError(err);
        }
      }

      async function handleResponse(res) {
        let payload = null;
        const text = await res.text();
        try {
          payload = text ? JSON.parse(text) : null;
        } catch (_) {
          payload = null;
        }

        const messages = [];
        const fieldErrors = payload && typeof payload.errors === "object" ? payload.errors : null;
        const globalMsg =
          (payload && (payload.message || payload.detail || payload.error)) ||
          (res.ok ? "Thanks! Your message was sent." : res.statusText);

        if (fieldErrors) {
          Object.entries(fieldErrors).forEach(([field, value]) => {
            const arr = Array.isArray(value) ? value : value ? [value] : [];
            arr.forEach((msg) => messages.push(`${field}: ${msg}`));
          });
        }
        if (globalMsg) messages.unshift(globalMsg);

        list.innerHTML = "";
        messages.forEach((msg) => {
          const li = document.createElement("li");
          li.textContent = msg;
          list.appendChild(li);
        });

        if (summary) {
          summaryTitle &&
            (summaryTitle.textContent = res.ok ? "Success" : "Please review and retry");
          summary.hidden = false;
          summary.classList.remove("is-hidden");
          summary.classList.toggle("is-success", res.ok);
          summary.focus({ preventScroll: false });
          summary.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      function showError(err) {
        if (!summary || !list) return;
        list.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = err?.message || "Network error. Please try again.";
        list.appendChild(li);
        summary.hidden = false;
        summary.classList.remove("is-hidden");
        summary.classList.remove("is-success");
        summary.focus({ preventScroll: false });
      }
    });
  });
</script>

<style>
  .form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    width: var(--form-width);
  }

  .form-body {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .form-actions {
    display: flex;
    justify-content: flex-start;
    gap: var(--space-3);
  }

  .form-error-summary {
    border: 1px solid color-mix(in srgb, var(--form-error-color) 60%, transparent);
    background: color-mix(in srgb, var(--form-error-color) 12%, transparent);
    color: var(--form-error-color);
    padding: var(--space-4);
    border-radius: var(--radius-sm);
  }
  .form-error-summary.is-success {
    border-color: color-mix(in srgb, var(--color-accent) 60%, transparent);
    background: color-mix(in srgb, var(--color-accent) 12%, transparent);
    color: var(--color-accent);
  }

  .form-error-summary .summary-title {
    margin: 0 0 var(--space-2) 0;
    font-weight: var(--weight-semibold);
  }

  .form-error-summary ul {
    margin: 0;
    padding-left: var(--space-4);
    display: grid;
    gap: var(--space-1);
  }

  .in-photo-roll {
    padding: 1rem 1rem 3rem 1rem;
    min-width: 100%;
    min-height: 100%;
    object-fit: var(--image-object-fit);
    object-position: var(--image-object-position);
    aspect-ratio: var(--image-aspect-ratio);
    scroll-snap-align: start;
    overflow-y: auto;
    overflow-x: hidden;
  }
</style>
