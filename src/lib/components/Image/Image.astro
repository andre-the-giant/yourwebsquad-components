---
/*
Props:
- format?: string
- quality?: number
- widths?: number[]
- alt?: string
- fetchpriority?: string
- loading?: "lazy" | "eager"
- sizes?: string
- src?: string
- id?: string
- class?: string
- style?: string
*/
import { Image } from "astro:assets";
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";

const localImages = import.meta.glob("/src/images/**/*", { eager: true });

function moduleToAsset(mod) {
  const candidate = mod?.default ?? mod;
  if (!candidate) return null;
  if (typeof candidate === "string") return candidate;
  if (typeof candidate?.src === "string") return candidate;
  return null;
}

function normalizeTarget(target = "") {
  return target.replace(/^\//, "").replace(/^src\/images\//, "").replace(/^images\//, "");
}

function findLocalAsset(target = "") {
  const normalized = normalizeTarget(target);
  if (!normalized) return null;

  for (const path in localImages) {
    if (path.endsWith(normalized)) {
      const asset = moduleToAsset(localImages[path]);
      if (asset) return asset;
    }
  }

  return null;
}

function resolveSrcValue(value) {
  if (!value) return null;

  if (typeof value === "object" && typeof value?.src === "string") {
    return moduleToAsset(value) ?? value;
  }

  if (typeof value !== "string") return null;

  const candidate = value.trim();
  if (!candidate) return null;

  if (/^(?:https?:)?\/\//i.test(candidate) || candidate.startsWith("data:")) return candidate;

  const local = findLocalAsset(candidate);
  if (local) return local;

  if (candidate.startsWith("/src/")) return candidate.replace(/^\/src/, "");
  if (candidate.startsWith("/images/")) return candidate;

  return candidate;
}

const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  format: { type: "string" },
  quality: { type: "number" },
  widths: { type: "array" },
  alt: { type: "string" },
  fetchpriority: { type: "string" },
  loading: { type: "string" },
  sizes: { type: "string" },
  src: { type: ["string", "object"] }
};

const defaultSrc = "https://picsum.photos/320/180";

const {
  id,
  class: className,
  style,
  format = "webp",
  quality = 60,
  widths = [640, 960, 1280, 1600, 1920],
  alt = "",
  fetchpriority = "high",
  loading = "lazy",
  sizes = "100vw",
  src = defaultSrc,
  ...rest
} = validateProps(schema, Astro.props, { component: "Image" });

const resolvedSrc = resolveSrcValue(src) ?? resolveSrcValue(defaultSrc) ?? defaultSrc;
const resolvedId = id ?? "image-" + Math.random().toString(36).slice(2, 9);

const imageDefaults = {
  format,
  sizes,
  quality,
  widths,
  fetchpriority,
  loading,
  width: 160,
  height: 90
};

const styleVars = {
  "--image-object-fit": "cover",
  "--image-object-position": "center",
  "--image-aspect-ratio": "16/9"
};

const resolvedStyle = makeStyleVars(styleVars, style);
const resolvedClass = mergeClasses("image", className);
---

<Image
  id={resolvedId}
  class={resolvedClass}
  {...imageDefaults}
  src={resolvedSrc}
  alt={alt}
  style={resolvedStyle || undefined}
  {...rest}
/>

<style>
  .image {
    width: 100%;
    height: 100%;
    object-fit: var(--image-object-fit);
    object-position: var(--image-object-position);
    aspect-ratio: var(--image-aspect-ratio);
  }
  .in-photo-roll {
    min-width: 100%;
    min-height: 100%;
    scroll-snap-align: start;
  }
</style>
