---
/*
Props:
- id?: string
- name?: string
- label?: string
- options?: Array<{ label: string, value: string, disabled?: boolean }>
- placeholder?: string
- value?: string
- disabled?: boolean
- required?: boolean
- ariaLabel?: string
- ariaDescribedBy?: string
- ariaInvalid?: boolean
- helpId?: string
- errorId?: string
- ariaControls?: string
- class?: string
- style?: string
Notes:
- component auto-generates an id when none is provided
*/
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";
import FormLabel from "../Form-Label/Form-Label.astro";

const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  name: { type: "string" },
  label: { type: "string" },
  options: { type: "array" },
  placeholder: { type: "string" },
  value: { type: ["string", "number"] },
  disabled: { type: "boolean" },
  required: { type: "boolean" },
  ariaLabel: { type: "string" },
  ariaDescribedBy: { type: "string" },
  ariaInvalid: { type: "boolean" },
  helpId: { type: "string" },
  errorId: { type: "string" },
  ariaControls: { type: "string" }
};

const {
  id,
  class: className,
  style,
  name,
  label,
  options = [],
  placeholder,
  value,
  disabled = false,
  required = false,
  ariaLabel,
  ariaDescribedBy,
  ariaInvalid = false,
  helpId,
  errorId,
  ariaControls,
  ...rest
} = validateProps(schema, Astro.props, { component: "Form-Select" });

const resolvedLabel = label;
const resolvedId = id ?? `form-select-${Math.random().toString(36).slice(2, 9)}`;
const resolvedPlaceholder = placeholder;
const selectedValue = value;

const describedIds = [ariaDescribedBy, helpId, errorId].filter(Boolean).join(" ");
const styleVars = {};
const resolvedStyle = makeStyleVars(styleVars, style);
const resolvedClass = mergeClasses("form-field", className);
---

<div class={resolvedClass} style={resolvedStyle || undefined}>
  {
    resolvedLabel ? (
      <FormLabel
        forId={resolvedId}
        label={resolvedLabel}
        required={required}
        descriptionId={describedIds}
      />
    ) : null
  }

  <select
    class="form-select"
    id={resolvedId}
    name={name}
    disabled={disabled}
    required={required}
    aria-label={ariaLabel}
    aria-describedby={describedIds || undefined}
    aria-invalid={ariaInvalid ? "true" : undefined}
    aria-controls={ariaControls || undefined}
    {...rest}
  >
    {
      resolvedPlaceholder ? (
        <option value="" disabled selected={!selectedValue} hidden>
          {resolvedPlaceholder}
        </option>
      ) : null
    }

    {
      options.map((opt) => (
        <option
          value={opt.value}
          disabled={opt.disabled}
          selected={opt.value == selectedValue ? true : undefined}
        >
          {opt.label}
        </option>
      ))
    }
  </select>
</div>

<style>
  .form-field {
    display: flex;
    flex-direction: column;
    gap: var(--form-field-gap);
    width: var(--form-width);
  }
  .form-label {
    font-size: var(--form-label-font-size);
    color: var(--color-fg-muted);
  }
  .form-select {
    padding: var(--form-input-padding);
    border: var(--form-input-border);
    border-radius: var(--form-input-border-radius);
    font-size: var(--size-md);
    font-family: var(--font-body);
    color: var(--color-fg);
    background: var(--form-input-bg);
    display: block;
    width: 100%;
    box-sizing: border-box;
  }
  .form-select:focus {
    outline: 2px solid var(--form-input-focus);
    outline-offset: 2px;
  }
  .form-select:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
