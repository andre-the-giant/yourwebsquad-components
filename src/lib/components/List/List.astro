---
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";
import Icon from "../Icon/Icon.astro";

/*
Props:
- as?: "ul" | "ol"
- items?: Array<string | { label: string; icon?: string }>
- icon?: string
- showIcon?: boolean
- gap?: string
- lineHeight?: string
- start?: number
- reversed?: boolean
- type?: "1" | "a" | "A" | "i" | "I"
- id?: string
- class?: string
- style?: string
Notes:
- direct props only; no content merges
*/
const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  as: { type: "string" },
  items: { type: "array" },
  icon: { type: "string" },
  showIcon: { type: "boolean" },
  gap: { type: "string" },
  lineHeight: { type: "string" },
  start: { type: ["number", "string"] },
  reversed: { type: "boolean" },
  type: { type: "string" }
};

const {
  id,
  class: className,
  style,
  as,
  items,
  icon,
  showIcon,
  numberStyle: _numberStyle,
  gap,
  lineHeight,
  start,
  reversed,
  type,
  ...rest
} = validateProps(schema, Astro.props, { component: "List" });

const resolvedAs = (as ?? "ul").toLowerCase() === "ol" ? "ol" : "ul";
const resolvedItems = Array.isArray(items) ? items : [];
const resolvedIcon = icon;
const resolvedShowIcon = showIcon ?? Boolean(resolvedIcon);
const resolvedGap = gap ?? "var(--space-2)";
const resolvedLineHeight = lineHeight ?? "var(--line-normal)";
const resolvedStart = start;
const resolvedReversed = reversed ?? false;
const resolvedType = type;
const resolvedId = id ?? "list-" + Math.random().toString(36).slice(2, 9);
const listClassName = mergeClasses("list", `list--${resolvedAs}`, className);
const hasCustomItems = Astro.slots.has("default");

const styleVars = {
  "--list-gap": resolvedGap,
  "--list-line": resolvedLineHeight,
  "--list-num-color": "currentColor",
  "--list-num-bg": "transparent",
  "--list-num-weight": "var(--weight-semibold)",
  "--list-num-size": "var(--size-sm)",
  "--list-num-radius": "999px"
};

const resolvedStyle = makeStyleVars(styleVars, style);
---

{
  resolvedAs === "ol" ? (
    <ol
      id={resolvedId}
      class={listClassName}
      start={resolvedStart}
      reversed={resolvedReversed || undefined}
      type={resolvedType}
      style={resolvedStyle || undefined}
      {...rest}
    >
      {hasCustomItems ? (
        <slot />
      ) : (
        resolvedItems.map((item) => {
          const it = typeof item === "string" ? { label: item } : item || {};
          return (
            <li class="list__item">
              <span class="list__marker list__marker--number" aria-hidden="true" />
              <span class="list__content">{it.label}</span>
            </li>
          );
        })
      )}
    </ol>
  ) : (
    <ul id={resolvedId} class={listClassName} style={resolvedStyle || undefined} {...rest}>
      {hasCustomItems ? (
        <slot />
      ) : (
        resolvedItems.map((item) => {
          const it = typeof item === "string" ? { label: item } : item || {};
          return (
            <li class="list__item">
              <span class="list__marker list__marker--icon">
                {resolvedShowIcon || it.icon ? (
                  <Icon content={{ name: it.icon ?? resolvedIcon }} size="sm" />
                ) : (
                  <span class="list__dot" aria-hidden="true" />
                )}
              </span>
              <span class="list__content">{it.label}</span>
            </li>
          );
        })
      )}
    </ul>
  )
}

<style>
  .list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: var(--list-gap);
    line-height: var(--list-line);
  }

  .list--ol {
    counter-reset: list-counter;
  }

  .list__item {
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: start;
    gap: var(--space-2);
  }

  .list__marker {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 1.5em;
    width: 1.5em;
    flex: 0 0 auto;
    color: inherit;
  }

  .list__marker--number {
    counter-increment: list-counter;
    font-weight: var(--list-num-weight);
    font-size: var(--list-num-size);
    color: var(--list-num-color, currentColor);
    background: var(--list-num-bg, transparent);
    border-radius: var(--list-num-radius);
    min-width: 1.5em;
    text-align: center;
    line-height: 1.4;
  }

  .list__marker--number::before {
    /* fall back to decimal; custom type handled by the <ol type> attribute */
    content: counter(list-counter, decimal) ".";
  }

  .list__dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
  }

  .list__content {
    display: inline-block;
  }

  .list :global(> li) {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .list :global(li > ul),
  .list :global(li > ol) {
    margin-top: var(--space-1);
    padding-left: 1.25rem;
  }
</style>
