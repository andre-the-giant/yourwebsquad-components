---
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";
import Form from "../Form/Form.astro";
import FormInput from "../Form-Input/Form-Input.astro";
import FormTextarea from "../Form-Textarea/Form-Textarea.astro";
import FormRadio from "../Form-Radio/Form-Radio.astro";
import FormHelp from "../Form-Help/Form-Help.astro";
import FormCheckbox from "../Form-Checkbox/Form-Checkbox.astro";
import FormFieldset from "../Form-Fieldset/Form-Fieldset.astro";
import FormHidden from "../Form-Hidden/Form-Hidden.astro";

/*
Props:
- id?: string
- action?: string
- defaultValues?: {
    name?: string;
    company?: string;
    city?: string;
    email?: string;
    phone?: string;
    preference?: "email" | "phone" | "";
    message?: string;
    services?: string[];
  }
- heading?: string
- description?: string
- submitLabel?: string
- resetLabel?: string
- class?: string
- style?: string
Notes:
- Required fields: name, email, contactMethod (default email).
- Uses Form molecule for submit/reset buttons.
*/
const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  action: { type: "string" },
  defaultValues: { type: "object" },
  heading: { type: "string" },
  description: { type: "string" },
  submitLabel: { type: "string" },
  resetLabel: { type: "string" }
};

const {
  id,
  class: className,
  style,
  action,
  defaultValues = {},
  heading = "Contact us",
  description = "Tell us a bit about your project and how to reach you.",
  submitLabel = "Send your message",
  resetLabel,
  ...rest
} = validateProps(schema, Astro.props, { component: "ContactForm" });

const formId = id ?? `contact-form-${Math.random().toString(36).slice(2, 9)}`;

const nameId = `${formId}-name`;
const companyId = `${formId}-company`;
const cityId = `${formId}-city`;
const emailId = `${formId}-email`;
const phoneId = `${formId}-phone`;
const messageId = `${formId}-message`;

const preference = defaultValues.preference ?? "";
const servicesSelected = Array.isArray(defaultValues.services) ? defaultValues.services : [];

const styleVars = {};
const resolvedStyle = makeStyleVars(styleVars, style);
const resolvedClass = mergeClasses("contact-form", className);
---

<Form
  id={formId}
  action={action}
  submitLabel={submitLabel}
  resetLabel={resetLabel}
  class={resolvedClass}
  style={resolvedStyle || undefined}
  {...rest}
>
  <header class="contact-form__header">
    <p class="contact-form__eyebrow">Get in touch</p>
    <h2 class="contact-form__title">{heading}</h2>
    <p class="contact-form__description">{description}</p>
  </header>

  <FormInput id={nameId} name="name" label="Name" required value={defaultValues.name} />

  <FormHidden id={`${formId}-honeypot`} name="middle_name" />

  <div class="contact-form__grid">
    <div>
      <FormInput id={companyId} name="company" label="Company name" value={defaultValues.company} />
    </div>
    <div>
      <FormInput id={cityId} name="city" label="City" value={defaultValues.city} />
    </div>
  </div>
  <div class="contact-form__grid">
    <div>
      <FormInput
        id={emailId}
        name="email"
        type="email"
        label="Email"
        required
        value={defaultValues.email}
      />
    </div>
    <div>
      <FormInput
        id={phoneId}
        name="phone"
        type="tel"
        label="Phone"
        value={defaultValues.phone}
        helpId={`${phoneId}-help`}
      />
      <FormHelp id={`${phoneId}-help`}>Optional. Include country code if international.</FormHelp>
    </div>
  </div>
  <FormFieldset legend="Preferred contact method" id={`${formId}-contact-method`} required>
    <div class="contact-form__radios">
      <FormRadio
        id={`${formId}-contact-method-email`}
        name="contactMethod"
        value="email"
        label="Email"
        checked={preference === "email"}
      />
      <FormRadio
        id={`${formId}-contact-method-phone`}
        name="contactMethod"
        value="phone"
        label="Phone"
        checked={preference === "phone"}
      />
    </div>
  </FormFieldset>

  <FormFieldset legend="Services" id={`${formId}-services`}>
    <div class="contact-form__services">
      <FormCheckbox
        id={`${formId}-service-brand`}
        name="services[]"
        label="Brand & Messaging"
        checked={servicesSelected.includes("brand")}
      />
      <FormCheckbox
        id={`${formId}-service-web`}
        name="services[]"
        label="Website & Hosting"
        checked={servicesSelected.includes("web")}
      />
      <FormCheckbox
        id={`${formId}-service-seo`}
        name="services[]"
        label="SEO & Performance"
        checked={servicesSelected.includes("seo")}
      />
    </div>
  </FormFieldset>

  <FormTextarea
    id={messageId}
    name="message"
    label="Tell us about your project"
    rows={5}
    required
    value={defaultValues.message}
  />
</Form>

<style>
  .contact-form {
    display: grid;
    gap: var(--space-4);
    width: min(720px, 100%);
  }

  .contact-form__header {
    display: grid;
    gap: var(--space-1);
  }

  .contact-form__eyebrow {
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: var(--size-xs);
    color: var(--color-fg-muted);
  }

  .contact-form__title {
    margin: 0;
    font-size: clamp(1.5rem, 1.8vw, 1.875rem);
    font-weight: var(--weight-semibold);
  }

  .contact-form__description {
    margin: 0;
    color: var(--color-fg-muted);
    font-size: var(--size-md);
  }

  .contact-form__grid {
    display: grid;
    gap: var(--space-3);
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }

  .contact-form__radios,
  .contact-form__services {
    display: grid;
    gap: var(--space-2);
  }
</style>
