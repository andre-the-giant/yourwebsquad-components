---
/*
Props:
- name?: string
- label?: string
- size?: "sm" | "md" | "lg"
- svgPath?: string
- svg?: string
- viewBox?: string
- strokeWidth?: string | number
- strokeLinecap?: string
- strokeLinejoin?: string
- id?: string
- class?: string
- style?: string
Notes:
- set label to expose aria-label; otherwise icon is aria-hidden
- Styling (color) is controlled via CSS vars (--icon-color).
*/
import { validateProps } from "../../utils/props.js";
import { makeStyleVars, mergeClasses } from "../../utils/style.js";
import icons from "./icons/index.js";

const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" },
  name: { type: "string" },
  label: { type: "string" },
  size: { type: "string" },
  svgPath: { type: "string" },
  svg: { type: "string" },
  viewBox: { type: "string" },
  strokeWidth: { type: ["string", "number"] },
  strokeLinecap: { type: "string" },
  strokeLinejoin: { type: "string" },
  rotate: { type: ["string", "number"] }
};

const {
  id,
  class: className,
  style,
  name,
  label,
  size = "md",
  color: _color,
  svgPath,
  svg,
  viewBox: viewBoxProp,
  strokeWidth: strokeWidthProp,
  strokeLinecap: strokeLinecapProp,
  strokeLinejoin: strokeLinejoinProp,
  rotate
} = validateProps(schema, Astro.props, { component: "Icon" });

const resolvedId = id ?? "icon-" + Math.random().toString(36).slice(2, 9);
const resolvedName = name ?? "spark";
const resolvedLabel = label;
const sizeMap = {
  sm: "16px",
  md: "24px",
  lg: "32px"
};
const iconSize = sizeMap[String(size)] ?? sizeMap.md;
const styleVars = {
  "--icon-size": iconSize,
  "--icon-color": "inherit",
  "--icon-rotation": (() => {
    if (rotate === undefined || rotate === null) return "0deg";
    if (typeof rotate === "number" && !Number.isNaN(rotate)) return `${rotate}deg`;
    const str = String(rotate).trim();
    return str || "0deg";
  })()
};
const resolvedStyle = makeStyleVars(styleVars, style);
const resolvedClass = mergeClasses("icon", className);

// sanitize incoming svg string: remove outer <svg> wrapper, strip inline styles and
// remove any fill/stroke attributes on inner elements so top-level SVG controls color.
function sanitizeSvgString(raw = "") {
  let s = String(raw).trim();
  // remove outer <svg ...> if present
  s = s.replace(/<svg[^>]*>/i, "").replace(/<\/svg>/i, "");
  // remove style/fill/stroke attributes on inner elements
  s = s.replace(/\s(?:style|fill|stroke)=("|').*?\1/gi, "");
  return s;
}

// resolve SVG inner markup and viewBox from either content.svgPath, content.svg, or registry
let innerSvg = "";
let viewBox = "0 0 24 24";
let iconStrokeWidth = "2";
let iconStrokeLinecap = "round";
let iconStrokeLinejoin = "round";
if (svgPath) {
  innerSvg = sanitizeSvgString(svgPath);
} else if (svg) {
  innerSvg = sanitizeSvgString(svg);
} else if (icons[String(resolvedName)]) {
  const def = icons[String(resolvedName)];
  innerSvg = sanitizeSvgString(def.svg || "");
  viewBox = def.viewBox || viewBox;
  if (def.strokeWidth) iconStrokeWidth = String(def.strokeWidth);
  if (def.strokeLinecap) iconStrokeLinecap = String(def.strokeLinecap);
  if (def.strokeLinejoin) iconStrokeLinejoin = String(def.strokeLinejoin);
}
if (viewBoxProp) viewBox = viewBoxProp;
if (strokeWidthProp) iconStrokeWidth = String(strokeWidthProp);
if (strokeLinecapProp) iconStrokeLinecap = String(strokeLinecapProp);
if (strokeLinejoinProp) iconStrokeLinejoin = String(strokeLinejoinProp);
---

<svg
  id={resolvedId}
  class={resolvedClass}
  width={iconSize}
  height={iconSize}
  viewBox={viewBox}
  fill="none"
  stroke="currentColor"
  stroke-width={iconStrokeWidth}
  stroke-linecap={iconStrokeLinecap}
  stroke-linejoin={iconStrokeLinejoin}
  role={resolvedLabel ? "img" : "presentation"}
  aria-hidden={resolvedLabel ? undefined : "true"}
  aria-label={resolvedLabel}
  style={resolvedStyle || undefined}
>
  {resolvedLabel && <title>{resolvedLabel}</title>}
  <g set:html={innerSvg} />
</svg>

<style>
  .icon {
    display: inline-flex;
    color: var(--icon-color, inherit);
    width: var(--icon-size);
    height: var(--icon-size);
    transform: rotate(var(--icon-rotation, 0deg));
    transform-origin: center center;
  }
</style>
