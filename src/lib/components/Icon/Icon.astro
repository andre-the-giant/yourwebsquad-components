---
// @ts-nocheck
/*
Props:
- content?: { name?: string, label?: string }
- name?: string
- label?: string
- size?: "sm" | "md" | "lg"
Notes:
- direct props override content.*
- set label to expose aria-label; otherwise icon is aria-hidden
*/
import icons from "./icons/index.js";

const { content = {}, name, label, size = "md", class: className, color } = Astro.props;

const resolvedName = name ?? content.name ?? "spark";
const resolvedLabel = label ?? content.label ?? content?.ariaLabel;
const sizeMap = {
  sm: "16px",
  md: "24px",
  lg: "32px"
};
const iconSize = sizeMap[String(size)] ?? sizeMap.md;
const styleColor = color ? `color: ${color};` : "";
const styleSize = `width: ${iconSize}; height: ${iconSize};`;

// sanitize incoming svg string: remove outer <svg> wrapper, strip inline styles and
// remove any fill/stroke attributes on inner elements so top-level SVG controls color.
function sanitizeSvgString(raw = "") {
  let s = String(raw).trim();
  // remove outer <svg ...> if present
  s = s.replace(/<svg[^>]*>/i, "").replace(/<\/svg>/i, "");
  // remove style/fill/stroke attributes on inner elements
  s = s.replace(/\s(?:style|fill|stroke)=("|').*?\1/gi, "");
  return s;
}

// resolve SVG inner markup and viewBox from either content.svgPath, content.svg, or registry
let innerSvg = "";
let viewBox = "0 0 24 24";
let iconStrokeWidth = "2";
let iconStrokeLinecap = "round";
let iconStrokeLinejoin = "round";
if (content && content.svgPath) {
  innerSvg = sanitizeSvgString(content.svgPath);
  if (content.viewBox) viewBox = content.viewBox;
  if (content.strokeWidth) iconStrokeWidth = String(content.strokeWidth);
  if (content.strokeLinecap) iconStrokeLinecap = String(content.strokeLinecap);
  if (content.strokeLinejoin) iconStrokeLinejoin = String(content.strokeLinejoin);
} else if (content && content.svg) {
  innerSvg = sanitizeSvgString(content.svg);
  if (content.viewBox) viewBox = content.viewBox;
  if (content.strokeWidth) iconStrokeWidth = String(content.strokeWidth);
  if (content.strokeLinecap) iconStrokeLinecap = String(content.strokeLinecap);
  if (content.strokeLinejoin) iconStrokeLinejoin = String(content.strokeLinejoin);
} else if (icons[String(resolvedName)]) {
  const def = icons[String(resolvedName)];
  innerSvg = sanitizeSvgString(def.svg || "");
  viewBox = def.viewBox || viewBox;
  if (def.strokeWidth) iconStrokeWidth = String(def.strokeWidth);
  if (def.strokeLinecap) iconStrokeLinecap = String(def.strokeLinecap);
  if (def.strokeLinejoin) iconStrokeLinejoin = String(def.strokeLinejoin);
}
---

<svg
  class={`icon ${className ?? ""}`.trim()}
  width={iconSize}
  height={iconSize}
  viewBox={viewBox}
  fill="none"
  stroke="currentColor"
  stroke-width={iconStrokeWidth}
  stroke-linecap={iconStrokeLinecap}
  stroke-linejoin={iconStrokeLinejoin}
  role={resolvedLabel ? "img" : "presentation"}
  aria-hidden={resolvedLabel ? undefined : "true"}
  aria-label={resolvedLabel}
  style={`${styleSize}${styleColor}`}
>
  {resolvedLabel && <title>{resolvedLabel}</title>}
  <g set:html={innerSvg} />
</svg>

<style>
  .icon {
    display: inline-flex;
    color: inherit;
  }
</style>
