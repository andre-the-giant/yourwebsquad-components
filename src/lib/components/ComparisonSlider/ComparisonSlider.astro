---
/*
Props:
- id?: string
- class?: string
- style?: string
Slots:
- before: content for the left pane
- after: content for the right pane
*/
import { validateProps } from "../../utils/props.js";

const schema = {
  id: { type: "string" },
  class: { type: "string" },
  style: { type: "string" }
};

const {
  id,
  class: className,
  style,
  ...rest
} = validateProps(schema, Astro.props, {
  component: "ComparisonSlider"
});

const resolvedId = id ?? "comparison-slider-" + Math.random().toString(36).slice(2, 9);
const resolvedClass = `compare ${className ?? ""}`.trim();
const resolvedStyle = [
  "--pos: 50%",
  "--comparison-height: 24rem",
  "--comparison-border: 3px solid #111",
  "--comparison-before-bg: #f5ede0",
  "--comparison-before-color: #0f172a",
  "--comparison-after-bg: #0f322a",
  "--comparison-after-color: #e6f1ea",
  style
]
  .filter(Boolean)
  .join("; ");
const defaultBefore = "I'm the left section";
const defaultAfter = "I'm the right section";
---

<div id={resolvedId} class={resolvedClass} style={resolvedStyle || undefined} {...rest}>
  <section class="before">
    <slot name="before">
      <p>{defaultBefore}</p>
    </slot>
  </section>
  <section class="after">
    <slot name="after">
      <p>{defaultAfter}</p>
    </slot>
  </section>
  <input
    type="range"
    min="0"
    max="100"
    value="50"
    step="0.1"
    data-role="range"
    aria-label="Drag to compare sections"
  />
</div>

<script is:inline define:vars={{ resolvedId }}>
  (() => {
    const root = document.getElementById(resolvedId);
    if (!root) return;
    if (root.dataset.bound === "true") return;
    const range = root.querySelector('[data-role="range"]');
    if (!(range instanceof HTMLInputElement)) return;

    const setPos = (val) => {
      const num = Number(val);
      const clamped = Number.isFinite(num) ? Math.min(100, Math.max(0, num)) : 50;
      root.style.setProperty("--pos", `${clamped}%`);
    };

    setPos(range.value || 50);
    range.addEventListener("input", () => setPos(range.value));
    root.dataset.bound = "true";
  })();
</script>

<style>
  .compare {
    display: grid;
    width: 100%;
    max-width: 960px;
    height: var(--comparison-height, 24rem);
    border: var(--comparison-border, 3px solid #111);
    overflow: hidden;
    background: #111;
  }
  .compare > * {
    grid-area: 1 / 1;
  }
  .before,
  .after {
    display: grid;
    place-items: center;
    text-align: center;
    font-size: clamp(1.5rem, 3vw, 2.5rem);
    font-weight: 700;
    padding: 1rem;
  }
  .before {
    background: var(--comparison-before-bg, #f5ede0);
    color: var(--comparison-before-color, #0f172a);
    -webkit-mask: linear-gradient(
      to right,
      #000 0,
      #000 var(--pos, 50%),
      transparent var(--pos, 50%),
      transparent 100%
    );
    mask: linear-gradient(
      to right,
      #000 0,
      #000 var(--pos, 50%),
      transparent var(--pos, 50%),
      transparent 100%
    );
  }
  .before :global(img),
  .after :global(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .after {
    background: var(--comparison-after-bg, #0f322a);
    color: var(--comparison-after-color, #e6f1ea);
    -webkit-mask: linear-gradient(
      to right,
      transparent 0,
      transparent var(--pos, 50%),
      #000 var(--pos, 50%),
      #000 100%
    );
    mask: linear-gradient(
      to right,
      transparent 0,
      transparent var(--pos, 50%),
      #000 var(--pos, 50%),
      #000 100%
    );
  }
  input[type="range"] {
    appearance: none;
    background: transparent;
    width: 100%;
    height: 100%;
    margin: 0;
    cursor: ew-resize;
    opacity: 0;
  }
  input[type="range"]:focus-visible {
    outline: 2px solid #111;
    outline-offset: 4px;
    opacity: 0.2;
  }
  @media (max-width: 768px) {
    .compare {
      height: 18rem;
    }
  }
</style>
